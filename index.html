<!DOCTYPE html>
<html>
<head>
   <title>藍單小幫手</title>
   <meta charset="utf-8">

   <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
   <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.37/css/bootstrap-datetimepicker.min.css">
   <style type="text/css">
      .container {
         margin-top: 40px;
      }
      .btn-primary {
         width: 100%;
      }
      .panel-heading{
         font-weight: bold;
      }
      .nav-tabs > li > a{
         font-size: medium;
      }
      .table tbody tr td{
         vertical-align: middle;
         text-align: center;
      }
      .table thead th{
         text-align: center;
      }
      #conversionTable td:last-child {
         text-align: left;
      }
      #timePanel .badge{
         font-size: medium;
         display:inline-block; 
         width:170px;
      }
   </style>

   <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script> 
   <script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/2.14.1/moment.min.js"></script> 
   <script type="text/javascript" src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script> 
   <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.37/js/bootstrap-datetimepicker.min.js"></script>

   <script type='text/javascript'>
      $( document ).ready(function() {
         $('#onsetTime').datetimepicker({
            format : 'YYYY/MM/DD HH:mm',
            defaultDate:new Date("2019/10/11 13:30")
         });
         $('#delivery').datetimepicker({
            format : 'YYYY/MM/DD HH:mm',
            defaultDate:new Date("2019/10/12 16:28")
         });
         $('#placenta').datetimepicker({
            format : 'YYYY/MM/DD HH:mm',
            defaultDate:new Date("2019/10/12 16:30")
         });
      });
      
      //Fold the panel with arrow sign
      $(document).on('click', '.panel-heading span.clickable', function (e) {
         var $this = $(this);
         if (!$this.hasClass('panel-collapsed')) {
            $this.parents('.panel').find('.panel-body').slideUp();
            $this.addClass('panel-collapsed');
            $this.find('i').removeClass('glyphicon-chevron-up').addClass('glyphicon-chevron-down');
         } else {
            $this.parents('.panel').find('.panel-body').slideDown();
            $this.removeClass('panel-collapsed');
            $this.find('i').removeClass('glyphicon-chevron-down').addClass('glyphicon-chevron-up');
         }
      })

      $(function(){
         // prevents jumping
         $("a.help").on("click", function (e) {
            e.preventDefault();
            return true;
         });
         $(".help").popover();
      });//]]> 
   </script>
</head>

<body>
<script>
   function processData() {
      var record = document.getElementById("record").value.replace(/\n/g,'<br>');
      var records = record.split(/(?=\d\d\/\d\d\s\d\d:\d\d)/);

      //Processed array: cArray[time,course,os,station,processed]
      var cArray= conversionArray(records);
      writeTable(cArray,"conversionTable");

      var rArray = resultArray(cArray);
      writeTable(rArray,"resultTable");
      
      document.getElementById("osCourse").innerHTML = timeFormat(osCourse);
      document.getElementById("deliveryCourse").innerHTML = timeFormat(deliveryCourse-osCourse);
      document.getElementById("placentaCourse").innerHTML = timeFormat(placentaCourse-deliveryCourse);
      document.getElementById("totalCourse").innerHTML = timeFormat(placentaCourse);
      $('#result').collapse('show');
   }

   //Get array from text records: [time,course,os,station,processed]
   function conversionArray(items){
      var pArray=[];
      for (var i = 0; i < items.length ; i++) {
         var temp = extractData(items[i]);
         pArray.push(temp);
      }
      var deliveryArray = getDelivery();
      pArray.push(deliveryArray);

      pArray.sort(function(a, b) {
         var valueA, valueB;

         valueA = a[1]; // sorting according to 2nd item
         valueB = b[1];
         if (valueA < valueB) { return -1;}
         else if (valueA > valueB) {return 1;}
         return 0;
      });

      return pArray;
   }
   
   function resultArray(myArray){
      var resultArray=[];
      var osFull = 0;

      for (var i = 0; i < myArray.length ; i++) {
         if ( myArray[i][2] == null && myArray[i][3] == null){continue;}
         var time = myArray[i][0];
         var formatted = timeFormat(myArray[i][1]);
         var os = myArray[i][2];
         var station = myArray[i][3];

         var cmStation = transStation(station);
         if (osFull == 1) {
            var cmOS = 10 ;
         } else {
            var cmOS = transOS(os);
            if (cmOS == 10){ 
               osCourse = myArray[i][1]; //global variable
               osFull = 1;
            }
         }

         resultArray.push([time, formatted, os, station, cmOS, cmStation]);
      }
      
      return resultArray;
   }

   function extractData(item){
      var time = null, course = null, os = null, station = null;
      var processed = item.toLowerCase().replace(/\~/g,'-');

      //Match time data and caculate clinical course
      var timeMatched = item.match(/\d\d\/\d\d\s\d\d:\d\d/);
      if ( timeMatched !== null){
         time = timeMatched[0];
         course = timeCourse(time);
      } 

      //Match station and os in a string
      var stringRegs = [
         "([0-5][\+\-]?[^0-9]{0,2})(fb?[\s\,，、。\/]+)([\+\-]?[0-3]\-?[\+\-]?[0-3]?)([\s\,，、。\/]+)",
         "([0-5][\+\-]?[^0-9]{0,2})(指[\s\,，、。\/]+)([\+\-]?[0-3]\-?[\+\-]?[0-3]?)([\s\,，、。\/]+)",
         "(full)([\s\,，、。\/]+)([\+\-]?[0-3]\-?[\+\-]?[0-3]?)([\s\,，、。\/]+)",
         "(ft)([\s\,，、。\/]+)([\+\-]?[0-3]\-?[\+\-\/]?[0-3]?)([\s\,，、。\/]+)",
         "(close)([\s\,，、。\/]+)(high)([\s\,，、。\/]+)"];
      for (var i=0 ; i < stringRegs.length ; i++) {
         var Reg = new RegExp(stringRegs[i]);
         var matched = null;
         
         matched = processed.match(Reg);
         if ( matched !== null ){
            os = matched[1];
            station = matched[3];
            processed = processed.replace(matched[0],'<span style="color:red;">'+matched[1]+'</span>'+matched[2]+'<span style="color:blue;">'+matched[3]+'</span>'+matched[4]);
         } 
      }

      //Match station
      if(station == null){
         var stationRegs = [
            "station[^0-9\+\-]{0,5}([\+\-]?[0-3]\-?[\+\-]?[0-3]?)",
            "胎位.{0,3}(高)",
            "胎位[^0-9\+\-]{0,5}([\+\-]?[0-3]\-?[\+\-]?[0-3]?)"];
         for (var i=0 ; i < stationRegs.length ; i++) {
            var Reg = new RegExp(stationRegs[i]);
            var matched = null;
            matched = processed.match(Reg);
            if ( matched !== null ){
               station = matched[1];
               processed = processed.replace(matched[0],'<span style="color:blue;">'+matched[0]+'</span>');
               break;
            } 
         }
      }

      //Match cervical os
      if(os == null){
         var osRegs = [
            "os[^0-9]{0,3}([0-5][\+\-]?).{0,2}fb",
            "子?宮頸?口?[^0-9]{0,3}([0-5][\+\-]?).{0,2}指",
            "子?宮頸?口?[^0-9]{0,3}([0-5][\+\-]?).{0,2}fb",
            "os.{0,3}([0-5][\+\-]?.{0,2})指",
            "os.{0,3}(full)",
            "內診.{0,5}(full)",
            "子?宮頸?口?.{0,3}(full)",
            "子?宮頸?口?.{0,3}(ft)",
            "子?宮頸?口?(全開)",
            "子?宮頸?口?.{0,3}(緊)",
            "os.{0,3}(緊)",
            "os.{0,3}(close)",
            "os.{0,3}(ft)"];
         for (var i=0 ; i < osRegs.length ; i++) {
            var Reg = new RegExp(osRegs[i]);
            var matched = null;
         
            matched = processed.match(Reg);
            if ( matched !== null ){
               os = matched[1];
               processed = processed.replace(matched[0],'<span style="color:red;">'+matched[0]+'</span>');
               break;
            } 
         }
      }

      return [time,course,os,station,processed];
   }

   function getDelivery(){
      var startTime = new Date($("#onsetTime").find("input").val());
      var deliveryString = $("#delivery").find("input").val();
      var deliveryTime = new Date(deliveryString);
      deliveryString = deliveryString.substr(5);

      var placentaString = $("#placenta").find("input").val();
      var placentaTime = new Date(placentaString);
      placentaCourse = ( placentaTime.getTime()-startTime.getTime() ) / 1000 / 60; //global variable

      var diff = deliveryTime.getTime() - startTime.getTime();
      deliveryCourse = diff / 1000 / 60; //global variable
      return [deliveryString,deliveryCourse,'full','+3','出生'];
   }

   function timeCourse(itemTime){
      var startTime = new Date($("#onsetTime").find("input").val());
      var year = startTime.getFullYear();
      var endTime = new Date(year+'/'+itemTime);
      if (startTime.getMonth() == 11 && endTime.getMonth() == 0){
         endTime.setYear(year+1);
      }

      var diff = endTime.getTime() - startTime.getTime();
      var resultTime = diff / 1000 / 60;
      return resultTime;
   }

   function timeFormat(minutes){
      var negative = false;
      if(minutes<0){
         minutes = -minutes;
         negative = true;
      }

      var days = Math.floor(minutes / 60 / 24);
      minutes -= days*1440;
      var hours = Math.floor(minutes / 60);
      var minutes = minutes%60;
      if (hours < 10 && hours>=0){ hours = "0" + hours; }
      if (minutes < 10){ minutes = "0" + minutes; }
      var formatted = hours + ":" + minutes;
      if (days > 0){ formatted = days + "D "+ formatted;}

      if (negative == true){formatted = '- '+ formatted;}
      return formatted;
   }

   function transOS(strOS){
      switch (strOS) {
         case "1": strOS = 2; break;
         case "2": strOS = 4; break;
         case "3": strOS = 6; break;
         case "4": strOS = 8; break;
         case "5": strOS = 10; break;
         case "1+": strOS = 3; break;
         case "2+": strOS = 5; break;
         case "3+": strOS = 7; break;
         case "4+": strOS = 9; break;
         case "1-": strOS = 1; break;
         case "2-": strOS = 3; break;
         case "3-": strOS = 5; break;
         case "4-": strOS = 7; break;
         case "ft": strOS = 1; break;
         case "close": strOS = 0; break;
         case "緊": strOS = 0; break;
         case "full": strOS = 10; break;
         case "全開": strOS = 10; break;
      }
      return strOS;
   }

   function transStation(strStation){
      switch (strStation) {
         case "-3": strStation = -3; break;
         case "-2": strStation = -2; break;
         case "-1": strStation = -1; break;
         case "0": strStation = 0; break;
         case "+1": strStation = 1; break;
         case "+2": strStation = 2; break;
         case "+3": strStation = 3; break;
         case "1": strStation = 1; break;
         case "2": strStation = 2; break;
         case "3": strStation = 3; break;
         case "-3--2": strStation = -2.5; break;
         case "-2--1": strStation = -1.5; break;
         case "-1-0": strStation = -0.5; break;
         case "0-+1": strStation = 0.5; break;
         case "+1-+2": strStation = 1.5; break;
         case "+2-+3": strStation = 2.5; break;
         case "0-1": strStation = 0.5; break;
         case "1-2": strStation = 1.5; break;
         case "2-3": strStation = 2.5; break;
         case "high": strStation = -3; break;
         case "高": strStation = -3; break;
      }
      return strStation;
   }

   function writeTable(myArray, myTable){
      $("#"+myTable).empty();
      var t = document.getElementById(myTable);
      for(var i=0;i<myArray.length;i++) {
         t.insertRow();
         for(var j=0;j<myArray[i].length;j++){
            t.rows[i].insertCell(j);
            t.rows[i].cells[j].innerHTML = myArray[i][j];
         }
      }
   }

   function showtext(id,text){
      document.getElementById(id).innerHTML = text;
   }
</script>


<div class="container">
   <div class="h2">藍單小幫手</div>
   <div class="panel panel-primary">
      <div class="panel-heading"> 
         Labor Course Data
         <span class="pull-right clickable"><i class="glyphicon glyphicon-chevron-up"></i></span>
      </div>
      <div class="panel-body">
         <div class="row">
            <div class='col-sm-4'>
               <div class="form-group">
                  <label class="control-label">Onset of true labor</label>
                  <div class='input-group date' id='onsetTime'>
                     <input type='text' class="form-control" />
                     <span class="input-group-addon">
                     <span class="glyphicon glyphicon-calendar"></span>
                     </span>
                  </div>
               </div>
            </div>
            <div class='col-sm-4'>
               <div class="form-group">
                  <label class="control-label">Delivery time</label>
                  <div class='input-group date' id='delivery'>
                     <input type='text' class="form-control" />
                     <span class="input-group-addon">
                     <span class="glyphicon glyphicon-calendar"></span>
                     </span>
                  </div>
               </div>
            </div>
            <div class="col-sm-4">
               <div class="form-group">
                  <label class="control-label">Placenta expulsion</label>
                  <div class='input-group date' id='placenta'>
                     <input type='text' class="form-control" />
                     <span class="input-group-addon">
                     <span class="glyphicon glyphicon-calendar"></span>
                     </span>
                  </div>
               </div>
            </div>
         </div>
         <div class="row">
            <div class="col-sm-12">
               <div class="form-group">
                  <label class="control-label">Nusing records&nbsp; <a class="help" data-toggle="popover" data-content='Input record will be separated by time in the form of "MM/DD mm:ss"' data-placement="right"><span class="glyphicon glyphicon-question-sign" style="color:grey"></span></a></label>
                  <textarea class="form-control" id='record' style="height:150px;"></textarea>
               </div>
            </div>
         </div>
         <input type="button" class="btn btn-primary" value="Submit" onclick='processData();' >
      </div>
   </div>
   <div id="result" class="collapse">
      <ul class="nav nav-tabs">
        <li class="active"><a data-toggle="tab" href="#resultTab">Result summary</a></li>
        <li><a data-toggle="tab" href="#convertTab">Conversion table</a></li>
        
      </ul>
      <div class="tab-content">
         <div id="resultTab" class="tab-pane fade in active">
            <div class="row" id="timePanel" style="text-align: center">
               <div class="col-xs-6 col-md-3" style="padding-top:10px">
                  <span class="badge badge-light">第一產程：<span id="osCourse"></span></span>
               </div>
               <div class="col-xs-6 col-md-3" style="padding-top:10px">
                  <span class="badge badge-light">第二產程：<span id="deliveryCourse"></span></span>
               </div>
               <div class="col-xs-6 col-md-3" style="padding-top:10px">
                  <span class="badge badge-light">第三產程：<span id="placentaCourse"></span></span>
               </div>
               <div class="col-xs-6 col-md-3" style="padding-top:10px">
                  <span class="badge badge-light">總時長：<span id="totalCourse"></span></span>
               </div>
            </div>
            <table class="table table-hover layout-fixed" style="table-layout: fixed; padding-top:20px">
               <thead class="thead-light">
                  <tr>
                     <th scope="col">時間</th>
                     <th scope="col">經時</th>
                     <th scope="col">OS</th>
                     <th scope="col">Station</th>
                     <th scope="col">OS (cm)</th>
                     <th scope="col">Station (cm)</th>
                  </tr>
               </thead>
               <tbody id="resultTable">
               </tbody>
            </table>
         </div>
         <div id="convertTab" class="tab-pane fade">
            <table class="table table-hover">
               <thead class="thead-light">
                  <tr>
                     <th scope="col">時間</th>
                     <th scope="col">分鐘</th>
                     <th scope="col">OS</th>
                     <th scope="col">Station</th>
                     <th scope="col">紀錄</th>
                  </tr>
               </thead>
               <tbody id="conversionTable">
               </tbody>
            </table>
         </div>
         <div id="partograph" class="tab-pane fade">
            <h4>Under constuction... (delayed indefinitely)</h4>
            <p></p>
         </div>
      </div>
   </div>
   </div>
</div>
      
</body>
</html>